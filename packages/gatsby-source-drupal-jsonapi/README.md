# Drupal content sourcing through JSON:API endpoints

## How to use

```javascript
// gatsby-config.js
module.exports = {
  plugins: [
    {
      resolve: '@eci/gatsby-source-drupal-jsonapi',
      options: {
        baseUrl: 'http://localhost:8080/web', // Drupal site URL.
        languages: ['en', 'bg', 'fr'],
        apiBase: 'api',
        basicAuth: {
          // For fetching unpublished content
          username: process.env.BASIC_AUTH_USERNAME,
          password: process.env.BASIC_AUTH_PASSWORD,
        },
        entities: [
          'node--faq',
          'node--faq_section',
          'node--oe_news',
          'node--oe_page',
          'menu',
        ],
      },
    },
  ],
};
```

## Notes

- Requires `entities` (Array<String>) to which entities to source: nodes, menus, etc.
- IDs are namespaced with `language` and `apiBase`, avoiding overrides because of same IDs generated by `createNodeId()` passed by `sourceNodes()`. An ID of a Gatsby node would have the pattern `api/bg/996f8aca-e3dd-5fbd-808a-b499a9497d5d` marking the fact that the given node is sourced by the specific language endpoint.
- Does not work with attachments, i.e. no Files are sourced.

## Content languages

The Gatsby's sourcing process will create mirror nodes of Drupal nodes.

When working with translations, keep in mind that a node is a translation when the language code of the node's id matches the `langcode` of the node's path alias.

When a node does not have a translation, the id will contain the language code of a target language, but the alias will be the default system language.

Examples:

Given the following node in the system's default language:

```json
{
  "node": {
    "id": "api/en/996f8aca-e3dd-5fbd-808a-b499a9497d5d",
    "path": {
      "langcode": "en"
    }
  }
}
```

If the given node does not have a translation:

```json
{
  "node": {
    "id": "api/bg/996f8aca-e3dd-5fbd-808a-b499a9497d5d",
    "path": {
      "langcode": "en"
    }
  }
}
```

In case there is an existing translation:

```json
{
  "node": {
    "id": "api/bg/996f8aca-e3dd-5fbd-808a-b499a9497d5d",
    "path": {
      "langcode": "bg"
    }
  }
}
```

## Working offline

When combining this plugin and ECI's CLI, it's possible to make a local mirror of Drupal's JSON:API:

In `.env`:

```
GATSBY_DRUPAL_API=https://remote-drupal.site
GATSBY_DRUPAL_API_OFFLINE=http://localhost:3000
DRUPAL_JSONAPI_OFFLINE_FOLDER=api/drupal/jsonapi
```

In the terminal:

Start from clean slate:

```sh
yarn eci-cli api clean
```

Mirror `GATSBY_DRUPAL_API` locally:

```sh
yarn eci-cli api download --entitiesConfig config/entities.json --languagesConfig config/languages.json
```

Serve local mirror on `GATSBY_DRUPAL_API_OFFLINE`:

```sh
yarn eci-cli api serve
```

In a separate session:

```sh
yarn start
```

You are no longer dependent on a working Drupal site. You can work offline or use mirror data for tests.
